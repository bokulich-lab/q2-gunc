{% extends 'base.html' %}

{% block head %}
<title>Contig QC Dashboard (Vega-Lite)</title>
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3.0.0/dist/d3-scale-chromatic.min.js"></script>
<link href="css/styles.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center" style="margin-top: 20px;">
    <div class="col-12">
      <!-- 1. Explanation Card -->
      <div class="card mb-4 border-muted" id="metadata-card">
        <div class="card-body p-3">
          <div class="card-text" style="color: #495057;">
            This visualization shows results of the GUNC analysis of the recovered MAGs.
          </div>
        </div>
      </div>
      
      <!-- 2. Sample and MAG Selectors -->
      <div class="card mb-4 border-muted" id="selector-card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-md-4">
              <label for="sample-selector" class="form-label">Select Sample:</label>
              <select class="form-select" id="sample-selector">
                <option value="">-- All Samples --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="level-selector" class="form-label">Taxonomic Level:</label>
              <select class="form-select" id="level-selector">
                <option value="kingdom">Kingdom</option>
                <option value="phylum">Phylum</option>
                <option value="class">Class</option>
                <option value="order">Order</option>
                <option value="family">Family</option>
                <option value="genus">Genus</option>
                <option value="species" selected>Species</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="mag-selector" class="form-label">Select MAG:</label>
              <select class="form-select" id="mag-selector" disabled>
                <option value="">-- Select a MAG --</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 3. GUNC Summary Visualization -->
      <div class="card mb-4 border-muted" id="summary-card">
        <div class="card-header">
          <h5 class="mb-0">MAG Quality Summary</h5>
        </div>
        <div class="card-body p-3">
          <div class="row">
            <!-- Left Column: Plot -->
            <div class="col-lg-6">
              <div id="gunc-summary-plot" style="min-height: 400px; width: 100%;"></div>
            </div>
            
            <!-- Right Column: Controls and Descriptions -->
            <div class="col-lg-6">
              <div class="mb-3">
                <h6>Controls</h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="filter-gunc-pass" checked>
                  <label class="form-check-label" for="filter-gunc-pass">
                    Show only MAGs that pass GUNC quality check
                  </label>
                </div>
              </div>
              
              <div class="mb-3">
                <h6>Data Summary</h6>
                <div id="data-summary" class="mb-2">
                  <small class="text-info">
                    <strong>Current View:</strong> <span id="data-count">Loading...</span>
                  </small>
                </div>
              </div>
              
              <div class="mb-3">
                <h6>Plot Guide</h6>
                <small class="text-muted">
                  <strong>Axes:</strong> X-axis shows reference representation score (higher = better quality), 
                  Y-axis shows contamination level (lower = better quality).<br>
                  <strong>Size:</strong> Point size indicates contig count.<br>
                  <strong>Interaction:</strong> Click and drag to zoom, double-click to reset.<br>
                  <strong>Colors:</strong> Viridis color scheme by sample.<br>
                  <strong>Shapes:</strong> Circles = Pass, Triangles = Fail.
                </small>
              </div>
              
              <div class="mb-3">
                <h6>Legend</h6>
                <div id="plot-legend">
                  <!-- Vega-Lite legend will be moved here if possible -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 4. Sankey Diagrams -->
      <div class="card mb-4 border-muted" id="plot-card" style="display: none;">
        <div class="card-header">
          <h5 class="mb-0">GUNC Sankey Diagram</h5>
        </div>
        <div class="card-body p-3">
          <div id="plot-container">
            <!-- Dynamic plot content will be loaded here -->
          </div>
          <div id="loading-spinner" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Data injected from Python ---
  let samples = {{ samples | safe }};
  let summaryData = {{ summary_data | safe }};
  
  // Create GUNC Summary Visualization
  function createSummaryPlot(filteredData = null) {
    let dataToUse = filteredData || summaryData;
    
    // Debug: Log initial data
    console.log(`Initial data: ${dataToUse.length} MAGs`);
    
    // Apply taxonomic level filter
    const levelSelector = document.getElementById('level-selector');
    const selectedLevel = levelSelector ? levelSelector.value : 'species';
    dataToUse = dataToUse.filter(d => d.taxonomic_level === selectedLevel);
    console.log(`After taxonomic level filter (${selectedLevel}): ${dataToUse.length} MAGs`);
    
    // Apply GUNC pass filter if checkbox is checked
    const filterCheckbox = document.getElementById('filter-gunc-pass');
    if (filterCheckbox && filterCheckbox.checked) {
      // Handle both boolean and string representations of pass/fail
      dataToUse = dataToUse.filter(d => {
        const passValue = d.pass_gunc;
        // Handle string "True"/"False", boolean true/false, or "Pass"/"Fail"
        return passValue === true || passValue === "True" || passValue === "true" || passValue === "Pass" || passValue === "pass";
      });
      console.log(`After GUNC pass filter: ${dataToUse.length} MAGs`);
    }
    
    // Check if we have any data left
    if (dataToUse.length === 0) {
      console.warn('No data to plot after filtering');
      
      // Update data summary to show no data
      const dataSummaryElement = document.getElementById('data-count');
      if (dataSummaryElement) {
        dataSummaryElement.textContent = 'No MAGs match current filters';
      }
      
      // Show empty plot or message
      const spec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "description": "No data available",
        "width": 400,
        "height": 400,
        "data": {"values": []},
        "mark": {"type": "text", "text": "No data matches current filters", "fontSize": 16, "color": "#666"},
        "encoding": {
          "x": {"value": 200},
          "y": {"value": 200}
        }
      };
      
      vegaEmbed('#gunc-summary-plot', spec, {actions: false}).catch(console.error);
      return;
    }
    
    // Debug: Log data sample
    console.log(`Sample of data being plotted:`, dataToUse.slice(0, 3));
    
    // Calculate dynamic axis limits
    const refScores = dataToUse.map(d => d.reference_representation_score);
    const contamLevels = dataToUse.map(d => d.contamination_portion);
    
    const minRefScore = Math.min(...refScores);
    const maxRefScore = Math.max(...refScores);
    const maxContam = Math.max(...contamLevels);
    
    // Smart axis limits
    const xMin = Math.max(0, minRefScore * 0.9); // 0.9x min value, but not below 0
    const xMax = Math.min(1.1, maxRefScore * 1.1); // 1.1x max value, but cap at 1.1
    const yMin = 0; // Always start contamination at 0
    const yMax = Math.min(1.1, maxContam * 1.1); // 1.1x max contamination, but cap at 1.1
    
    console.log(`Axis limits - X: [${xMin}, ${xMax}], Y: [${yMin}, ${yMax}]`);
    
    // Update data summary display with unique MAG counts
    const dataSummaryElement = document.getElementById('data-count');
    if (dataSummaryElement) {
      const uniqueMAGs = new Set(dataToUse.map(d => d.mag_id)).size;
      const sampleCount = new Set(dataToUse.map(d => d.sample_id)).size;
      
      // Count passes more robustly
      const passCount = dataToUse.filter(d => {
        const passValue = d.pass_gunc;
        return passValue === true || passValue === "True" || passValue === "true" || passValue === "Pass" || passValue === "pass";
      }).length;
      const failCount = dataToUse.length - passCount;
      
      dataSummaryElement.textContent = `${uniqueMAGs} unique MAGs from ${sampleCount} sample(s) (${passCount} pass, ${failCount} fail)`;
    }
    
    // Normalize pass_gunc field to boolean for Vega-Lite
    const normalizedData = dataToUse.map(d => ({
      ...d,
      pass_gunc: d.pass_gunc === true || d.pass_gunc === "True" || d.pass_gunc === "true" || d.pass_gunc === "Pass" || d.pass_gunc === "pass"
    }));

    console.log(`Normalized data:`, normalizedData);
    
    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "MAG Quality Summary from GUNC Analysis",
      "width": 400,
      "height": 400,
      "data": {
        "values": normalizedData
      },
      "params": [
        {
          "name": "grid",
          "select": "interval",
          "bind": "scales"
        },
        {
          "name": "ref_score_min",
          "value": xMin,
          "bind": {
            "input": "range",
            "min": xMin,
            "max": xMax,
            "step": 0.01,
            "name": "Min Reference Score: "
          }
        },
        {
          "name": "contam_max",
          "value": yMax,
          "bind": {
            "input": "range",
            "min": yMin,
            "max": yMax,
            "step": 0.01,
            "name": "Max Contamination: "
          }
        }
      ],
      "transform": [
        {
          "filter": "datum.reference_representation_score >= ref_score_min"
        },
        {
          "filter": "datum.contamination_portion <= contam_max"
        }
      ],
      "mark": {
        "type": "point",
        "strokeWidth": 1.5
      },
      "encoding": {
        "x": {
          "field": "reference_representation_score",
          "type": "quantitative",
          "scale": {"domain": [xMin, xMax]},
          "title": "Reference Representation Score",
          "axis": {"grid": true, "gridOpacity": 0.6}
        },
        "y": {
          "field": "contamination_portion", 
          "type": "quantitative",
          "scale": {"domain": [yMin, yMax], "reverse": true},
          "title": "Contamination Portion",
          "axis": {"grid": true, "gridOpacity": 0.6}
        },
        "size": {
          "field": "n_contigs",
          "type": "quantitative",
          "scale": {"range": [50, 400]},
          "title": "Number of Contigs"
        },
        "color": {
          "field": "sample_id",
          "type": "nominal",
          "scale": {"scheme": "viridis"},
          "title": "Sample ID"
        },
        "fill": {
          "field": "sample_id",
          "type": "nominal",
          "scale": {"scheme": "viridis"},
        },
        "fillOpacity": {
          "condition": {
            "test": "datum.pass_gunc",
            "value": 1
          },
          "value": 0
        },
        "tooltip": [
          {"field": "sample_id", "type": "nominal", "title": "Sample ID"},
          {"field": "mag_id", "type": "nominal", "title": "MAG ID"},
          {"field": "reference_representation_score", "type": "quantitative", "title": "Reference Rep. Score", "format": ".3f"},
          {"field": "contamination_portion", "type": "quantitative", "title": "Contamination", "format": ".3f"},
          {"field": "genes_retained_index", "type": "quantitative", "title": "Genes Retained Index", "format": ".3f"},
          {"field": "n_contigs", "type": "quantitative", "title": "Contigs"},
          {"field": "n_genes_mapped", "type": "quantitative", "title": "Genes Mapped"},
          {"field": "pass_gunc", "type": "nominal", "title": "GUNC Pass"}
        ]
      }
    };
    
    vegaEmbed('#gunc-summary-plot', spec, {
      actions: true
    }).then(result => {
      // Add custom styling to the sliders
      const container = document.getElementById('gunc-summary-plot');
      const sliders = container.querySelectorAll('.vega-bindings');
      
      if (sliders.length > 0) {
        sliders.forEach(slider => {
          slider.style.marginBottom = '10px';
          slider.style.fontSize = '12px';
        });
        
        // Try to organize sliders by axis
        const allSliders = container.querySelectorAll('.vega-bind');
        allSliders.forEach((slider, index) => {
          slider.style.marginBottom = '8px';
          slider.style.display = 'block';
          
          // Style the range inputs
          const rangeInput = slider.querySelector('input[type="range"]');
          if (rangeInput) {
            rangeInput.style.width = '150px';
            rangeInput.style.marginLeft = '10px';
          }
        });
      }
    }).catch(console.error);
  }
  
  // Initialize dropdowns
  document.addEventListener('DOMContentLoaded', function() {
    const sampleSelector = document.getElementById('sample-selector');
    const magSelector = document.getElementById('mag-selector');
    const plotCard = document.getElementById('plot-card');
    const plotContainer = document.getElementById('plot-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    
    // Create the summary plot
    createSummaryPlot();
    
    // Add event listener for GUNC pass filter checkbox
    const filterCheckbox = document.getElementById('filter-gunc-pass');
    if (filterCheckbox) {
      filterCheckbox.addEventListener('change', updatePlot);
    }
    
    // Add event listener for taxonomic level selector
    const levelSelector = document.getElementById('level-selector');
    if (levelSelector) {
      levelSelector.addEventListener('change', updatePlot);
    }
    
    // Function to update plot based on current selections
    function updatePlot() {
      const selectedSample = sampleSelector.value;
      if (selectedSample === "") {
        createSummaryPlot();
      } else {
        const filteredData = summaryData.filter(item => item.sample_id === selectedSample);
        createSummaryPlot(filteredData);
      }
    }
    
    // Populate sample dropdown with "All Samples" option first
    const sampleKeys = Object.keys(samples).sort();
    sampleKeys.forEach(sampleId => {
      const option = document.createElement('option');
      option.value = sampleId;
      // Handle empty string keys with a more descriptive label
      option.textContent = sampleId === "" ? "(Default)" : sampleId;
      sampleSelector.appendChild(option);
    });
    
    // Default to showing all samples (empty value = all samples)
    sampleSelector.value = "";
    magSelector.disabled = true;
    
    // Function to populate MAG dropdown
    function populateMAGs(selectedSample) {
      magSelector.innerHTML = '<option value="">-- Select a MAG --</option>';
      plotCard.style.display = 'none';
      
      // Handle "All Samples" selection (empty value)
      if (selectedSample === "" || selectedSample === null || selectedSample === undefined) {
        magSelector.disabled = true;
        return;
      }
      
      // Check if selectedSample exists as a key in samples (including empty string)
      const hasValidSample = samples.hasOwnProperty(selectedSample);
      magSelector.disabled = !hasValidSample;
      
      if (hasValidSample && samples[selectedSample]) {
        const magIds = samples[selectedSample].slice().sort();
        magIds.forEach(magId => {
          const option = document.createElement('option');
          option.value = magId;
          option.textContent = magId;
          magSelector.appendChild(option);
        });
        
        // Preselect first MAG if available
        if (magIds.length > 0) {
          magSelector.value = magIds[0];
          // Automatically load the plot for the first MAG
          loadPlot(selectedSample, magIds[0]);
        }
      }
    }
    
    // Handle sample selection
    sampleSelector.addEventListener('change', function() {
      const selectedSample = this.value;
      
      // Update plot with new sample selection
      updatePlot();
      
      // Update MAG dropdown
      populateMAGs(selectedSample);
    });
    
    // Handle MAG selection
    magSelector.addEventListener('change', function() {
      const selectedSample = sampleSelector.value;
      const selectedMag = this.value;
      
      // Check if we have valid selections (including empty string sample keys)
      const hasValidSample = selectedSample !== null && selectedSample !== undefined && samples.hasOwnProperty(selectedSample);
      const hasValidMag = selectedMag && selectedMag !== "";
      
      if (hasValidSample && hasValidMag) {
        loadPlot(selectedSample, selectedMag);
      } else {
        plotCard.style.display = 'none';
      }
    });
    
    // Function to load plot HTML
    function loadPlot(sampleId, magId) {
      const plotUrl = `plots/${sampleId}/${magId}.viz.html`;
      
      plotCard.style.display = 'block';
      loadingSpinner.style.display = 'block';
      plotContainer.innerHTML = '';
      
      fetch(plotUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load plot: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(html => {
          plotContainer.innerHTML = html;
          loadingSpinner.style.display = 'none';
          
          // Execute any scripts in the loaded HTML
          const scripts = plotContainer.querySelectorAll('script');
          scripts.forEach(script => {
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            if (script.src) {
              newScript.src = script.src;
            }
            document.head.appendChild(newScript);
          });
        })
        .catch(error => {
          console.error('Error loading plot:', error);
          plotContainer.innerHTML = `
            <div class="alert alert-warning" role="alert">
              <h6>Plot not available</h6>
              <p>Could not load plot for sample "${sampleId}" and MAG "${magId}".</p>
              <small class="text-muted">Expected location: ${plotUrl}</small>
            </div>
          `;
          loadingSpinner.style.display = 'none';
        });
    }
  });
</script>

{% endblock %}

{% block footer %}
{% set loading_selector = '#loading' %}
{% include 'js-error-handler.html' %}
{% endblock %}
