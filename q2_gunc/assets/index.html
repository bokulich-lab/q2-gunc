{% extends 'base.html' %}

{% block head %}
<title>Contig QC Dashboard (Vega-Lite)</title>
<!-- DaisyUI & Tailwind CDN -->
<link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<link href="css/styles.css" rel="stylesheet"/>
<link href="css/normalize.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="w-full min-h-screen bg-base-200 flex flex-col items-center py-8">
  <div class="w-full">
    <div class="flex w-full items-stretch">

      <!-- 1. Sample and MAG Selectors -->
      <div class="w-5/6">
        <div class="card bg-base-100 shadow-md mb-6 ml-4 mr-4" id="selector-card">
          <div class="card-body">
            <h2 class="card-title mb-1 mt-1">Plot controls</h2>
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-1">
                <fieldset class="fieldset text-sm">
                  <label class="label">Sample</label>
                  <select class="select select-sm w-full" id="sample-selector">
                    <option value="" selected>-- All samples --</option>
                  </select>

                  <label class="label">Taxonomic level</label>
                  <select class="select select-sm w-full" id="level-selector">
                    <option value="kingdom">Kingdom</option>
                    <option value="phylum">Phylum</option>
                    <option value="class">Class</option>
                    <option value="order">Order</option>
                    <option value="family">Family</option>
                    <option value="genus">Genus</option>
                    <option value="species" selected>Species</option>
                  </select>

                  <label class="label">MAG</label>
                  <select class="select select-sm w-full" id="mag-selector">
                    <option value="">-- Select a MAG --</option>
                  </select>
                </fieldset>
              </div>

              <div class="flex-1 items-start ml-2">
                <fieldset class="fieldset text-sm" id="controls-container">
                  <p>
                    <input type="checkbox" class="checkbox checkbox-sm" id="filter-gunc-pass">
                    <span>Show GUNC-failed MAGs</span>
                  </p>
                  <p>
                    <input type="checkbox" class="checkbox checkbox-sm" id="reverse-y-axis" checked="checked">
                    <span>Reverse Y-axis</span>
                  </p>
                </fieldset>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="w-1/6 flex items-center justify-center mb-6 mr-4">
        <div class="stats stats-vertical shadow-md h-full w-full">
          <div class="stat bg-white">
            <div class="stat-title font-semibold">Samples</div>
            <div class="stat-value text-info"></div>
          </div>
          <div class="stat bg-white">
            <div class="stat-title font-semibold">MAGs</div>
            <div class="stat-value text-accent"></div>
            <div class="stat-desc">passing</div>
          </div>
          <div class="stat bg-white">
            <div class="stat-title font-semibold">MAGs</div>
            <div class="stat-value text-error"></div>
            <div class="stat-desc">failing</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. GUNC Summary Visualization -->
    <div class="card bg-base-100 shadow-md mb-6 ml-4 mr-4" id="summary-card">
      <div class="card-body p-6">
        <h2 class="card-title mb-1 mt-1">MAG quality summary</h2>
        <div id="gunc-summary-plot" class="min-h-[400px] w-full"></div>
      </div>
    </div>

    <!-- 3. Sankey Diagrams -->
    <div class="card bg-base-100 shadow-md mb-6 ml-4 mr-4" id="plot-card" style="display: none;">
      <div class="card-body p-6">
        <h2 class="card-title mb-4">GUNC Sankey diagram</h2>
        <div id="plot-container"></div>
        <div id="loading-spinner" class="flex justify-center mt-4" style="display: none;">
          <span class="loading loading-spinner loading-lg"></span>
        </div>
      </div>
    </div>

  </div>
</div>
<script>
  // --- Data injected from Python ---
  let samples = {{ samples | safe }};
  let summaryData = {{ summary_data | safe }};
  
  // Create GUNC Summary Visualization
  function createSummaryPlot(filteredData = null, reverseY = true) {
    let dataToUse = filteredData || summaryData;
    
    // Debug: Log initial data
    console.log(`Initial data: ${dataToUse.length} MAGs`);
    
    // Apply taxonomic level filter
    const levelSelector = document.getElementById('level-selector');
    const selectedLevel = levelSelector ? levelSelector.value : 'species';
    dataToUse = dataToUse.filter(d => d.taxonomic_level === selectedLevel);
    console.log(`After taxonomic level filter (${selectedLevel}): ${dataToUse.length} MAGs`);
    
    // Apply GUNC pass filter if checkbox is checked
    const filterCheckbox = document.getElementById('filter-gunc-pass');
    if (filterCheckbox && ! filterCheckbox.checked) {
      // Handle both boolean and string representations of pass/fail
      dataToUse = dataToUse.filter(d => {
        const passValue = d.pass_gunc;
        // Handle string "True"/"False", boolean true/false, or "Pass"/"Fail"
        return passValue === true || passValue === "True" || passValue === "true" || passValue === "Pass" || passValue === "pass";
      });
      console.log(`After GUNC pass filter: ${dataToUse.length} MAGs`);
    }
    
    // Check if we have any data left
    if (dataToUse.length === 0) {
      console.warn('No data to plot after filtering');
      
      // Show empty plot or message
      const spec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
        "description": "No data available",
        "width": 400,
        "height": 400,
        "data": {"values": []},
        "mark": {"type": "text", "text": "No data matches current filters", "fontSize": 18, "color": "#666"},
        "encoding": {
          "x": {"value": 200},
          "y": {"value": 200}
        }
      };
      
      vegaEmbed('#gunc-summary-plot', spec, {actions: false}).catch(console.error);
      return;
    }
    
    // Calculate dynamic axis limits
    // Filter out null/undefined/non-numeric values
    const refScores = dataToUse.map(d => Number(d.reference_representation_score)).filter(v => typeof v === 'number' && !isNaN(v));
    const contamLevels = dataToUse.map(d => Number(d.contamination_portion)).filter(v => typeof v === 'number' && !isNaN(v));

    let minRefScore = refScores.length > 0 ? Math.min(...refScores) : 0;
    let maxRefScore = refScores.length > 0 ? Math.max(...refScores) : 1;
    let maxContam = contamLevels.length > 0 ? Math.max(...contamLevels) : 1;

    // Smart axis limits with fallbacks
    let xMin = Math.max(0, minRefScore * 0.9).toFixed(2); // 0.9x min value, but not below 0
    let xMax = Math.min(1.1, maxRefScore * 1.1).toFixed(2); // 1.1x max value, but cap at 1.1
    let yMin = 0; // Always start contamination at 0
    let yMax = Math.min(1.1, maxContam * 1.1).toFixed(2); // 1.1x max contamination, but cap at 1.1

    // If ranges are invalid, set to defaults and warn
    if (!isFinite(xMin) || !isFinite(xMax) || xMin === xMax) {
      console.warn('Invalid X axis range, using default [0,1]');
      xMin = 0; xMax = 1;
    }
    if (!isFinite(yMin) || !isFinite(yMax) || yMin === yMax) {
      console.warn('Invalid Y axis range, using default [0,1]');
      yMin = 0; yMax = 1;
    }
    
    console.log(`Axis limits - X: [${xMin}, ${xMax}], Y: [${yMin}, ${yMax}]`);

    // Update summary-card badge spans
    const sampleCountSpan = document.querySelector('.stat-value.text-info');
    const passCountSpan = document.querySelector('.stat-value.text-accent');
    const failCountSpan = document.querySelector('.stat-value.text-error');

    const sampleCount = new Set(dataToUse.map(d => d.sample_id)).size;
    const passCount = dataToUse.filter(d => {
      const passValue = d.pass_gunc;
      return passValue === true || passValue === "True" || passValue === "true" || passValue === "Pass" || passValue === "pass";
    }).length;
    const failCount = dataToUse.length - passCount;

    if (sampleCountSpan) sampleCountSpan.textContent = sampleCount;
    if (passCountSpan) passCountSpan.textContent = passCount;
    if (failCountSpan) failCountSpan.textContent = failCount;
    
    // Normalize pass_gunc field to boolean for Vega-Lite
    const normalizedData = dataToUse.map(d => ({
      ...d,
      pass_gunc: d.pass_gunc === true || d.pass_gunc === "True" || d.pass_gunc === "true" || d.pass_gunc === "Pass" || d.pass_gunc === "pass"
    }));

    console.log(`Normalized data:`, normalizedData);
    
    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
      "description": "MAG Quality Summary from GUNC Analysis",
      "width": "container",
      "height": 500,
      "data": {
        "values": normalizedData
      },
      "params": [
        {
          "name": "grid",
          "select": "interval",
          "bind": "scales"
        },
        {
          "name": "ref_score_min",
          "value": xMin,
          "bind": {
            "input": "range",
            "min": xMin,
            "max": xMax,
            "step": 0.01,
            "name": "Min. reference score:"
          }
        },
        {
          "name": "contam_max",
          "value": yMax,
          "bind": {
            "input": "range",
            "min": yMin,
            "max": yMax,
            "step": 0.01,
            "name": "Max. contamination:"
          }
        }
      ],
      "config": {
        "legend": {
          "orient": "right",
          "titleFontSize": 13,
          "labelFontSize": 12,
          "columns": 3
        }
      },
      "transform": [
        {
          "filter": "datum.reference_representation_score >= ref_score_min"
        },
        {
          "filter": "datum.contamination_portion <= contam_max"
        }
      ],
      "mark": {
        "type": "point",
        "strokeWidth": 1.5
      },
      "encoding": {
        "x": {
          "field": "reference_representation_score",
          "type": "quantitative",
          "scale": {"domain": [xMin, xMax]},
          "title": "Reference Representation Score",
          "axis": {"grid": true, "gridOpacity": 0.6, "titleFontSize": 15, "labelFontSize": 13}
        },
        "y": {
          "field": "contamination_portion", 
          "type": "quantitative",
          "scale": {"domain": [yMin, yMax], "reverse": reverseY},
          "title": "Contamination Fraction",
          "axis": {"grid": true, "gridOpacity": 0.6, "titleFontSize": 15, "labelFontSize": 13}
        },
        "size": {
          "field": "n_contigs",
          "type": "quantitative",
          "scale": {"range": [100, 400]},
          "title": "Number of contigs"
        },
        "color": {
          "field": "sample_id",
          "type": "nominal",
          "scale": {"scheme": "viridis"},
          "title": "Sample ID"
        },
        "fill": {
          "field": "sample_id",
          "type": "nominal",
          "scale": {"scheme": "viridis"},
        },
        "fillOpacity": {
          "condition": {
            "test": "datum.pass_gunc",
            "value": 1
          },
          "value": 0
        },
        "tooltip": [
          {"field": "sample_id", "type": "nominal", "title": "Sample ID"},
          {"field": "mag_id", "type": "nominal", "title": "MAG ID"},
          {"field": "reference_representation_score", "type": "quantitative", "title": "Reference Rep. Score", "format": ".3f"},
          {"field": "contamination_portion", "type": "quantitative", "title": "Contamination", "format": ".3f"},
          {"field": "genes_retained_index", "type": "quantitative", "title": "Genes Retained Index", "format": ".3f"},
          {"field": "n_contigs", "type": "quantitative", "title": "Contigs"},
          {"field": "n_genes_mapped", "type": "quantitative", "title": "Genes Mapped"},
          {"field": "pass_gunc", "type": "nominal", "title": "GUNC Pass"}
        ]
      }
    };
    
    vegaEmbed('#gunc-summary-plot', spec, {
      actions: true
    }).then(result => {
      // Add custom styling to the sliders
      const container = document.getElementById('gunc-summary-plot');

      // Move the sliders container to the controls-container div
      const controlsContainer = document.getElementById('controls-container');
      const sliders = container.querySelector('.vega-bindings');
      if (controlsContainer && sliders) {
        console.log("Moving Vega-Lite sliders to controls-container...");
        console.log("controlsContainer:", controlsContainer);
        console.log("sliders:", sliders);
        // If a previous .vega-bindings exists in controlsContainer, remove it before appending the new one
        const oldBindings = controlsContainer.querySelector('.vega-bindings');
        if (oldBindings && oldBindings !== sliders) {
          oldBindings.remove();
        }
        controlsContainer.appendChild(sliders);
      }
    }).catch(console.error);
  }
  
  // Initialize dropdowns
  document.addEventListener('DOMContentLoaded', function() {
    const sampleSelector = document.getElementById('sample-selector');
    const magSelector = document.getElementById('mag-selector');
    const plotCard = document.getElementById('plot-card');
    const plotContainer = document.getElementById('plot-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const reverseYAxisCheckbox = document.getElementById('reverse-y-axis');
    
    // Create the summary plot
    createSummaryPlot(null, reverseYAxisCheckbox ? reverseYAxisCheckbox.checked : true);
    
    // Add event listener for GUNC pass filter checkbox
    const filterCheckbox = document.getElementById('filter-gunc-pass');
    if (filterCheckbox) {
      filterCheckbox.addEventListener('change', updatePlot);
    }
    
    // Add event listener for taxonomic level selector
    const levelSelector = document.getElementById('level-selector');
    if (levelSelector) {
      levelSelector.addEventListener('change', updatePlot);
    }

    // Add event listener for Y-axis reversal checkbox
    if (reverseYAxisCheckbox) {
      reverseYAxisCheckbox.addEventListener('change', updatePlot);
    }
    
    // Function to update plot based on current selections
    function updatePlot() {
      const selectedSample = sampleSelector.value;
      const reverseY = reverseYAxisCheckbox ? reverseYAxisCheckbox.checked : true;
      if (selectedSample === "") {
        createSummaryPlot(null, reverseY);
      } else {
        const filteredData = summaryData.filter(item => item.sample_id === selectedSample);
        createSummaryPlot(filteredData, reverseY);
      }
    }
    
    // Populate sample dropdown with "All Samples" option first
    const sampleKeys = Object.keys(samples).sort();
    sampleKeys.forEach(sampleId => {
      const option = document.createElement('option');
      option.value = sampleId;
      // Handle empty string keys with a more descriptive label
      option.textContent = sampleId === "" ? "(Default)" : sampleId;
      sampleSelector.appendChild(option);
    });
    
    // Default to showing all samples (empty value = all samples)
    sampleSelector.value = "";
    magSelector.disabled = true;
    
    // Function to populate MAG dropdown
    function populateMAGs(selectedSample) {
      magSelector.innerHTML = '<option value="">-- Select a MAG --</option>';
      plotCard.style.display = 'none';
      
      // Handle "All Samples" selection (empty value)
      if (selectedSample === "" || selectedSample === null || selectedSample === undefined) {
        magSelector.disabled = true;
        return;
      }
      
      // Check if selectedSample exists as a key in samples (including empty string)
      const hasValidSample = samples.hasOwnProperty(selectedSample);
      magSelector.disabled = !hasValidSample;
      
      if (hasValidSample && samples[selectedSample]) {
        const magIds = samples[selectedSample].slice().sort();
        magIds.forEach(magId => {
          const option = document.createElement('option');
          option.value = magId;
          option.textContent = magId;
          magSelector.appendChild(option);
        });
        
        // Preselect first MAG if available
        if (magIds.length > 0) {
          magSelector.value = magIds[0];
          // Automatically load the plot for the first MAG
          loadPlot(selectedSample, magIds[0]);
        }
      }
    }
    
    // Handle sample selection
    sampleSelector.addEventListener('change', function() {
      const selectedSample = this.value;
      
      // Update plot with new sample selection
      updatePlot();
      
      // Update MAG dropdown
      populateMAGs(selectedSample);
    });
    
    // Handle MAG selection
    magSelector.addEventListener('change', function() {
      const selectedSample = sampleSelector.value;
      const selectedMag = this.value;
      
      // Check if we have valid selections (including empty string sample keys)
      const hasValidSample = selectedSample !== null && selectedSample !== undefined && samples.hasOwnProperty(selectedSample);
      const hasValidMag = selectedMag && selectedMag !== "";
      
      if (hasValidSample && hasValidMag) {
        loadPlot(selectedSample, selectedMag);
      } else {
        plotCard.style.display = 'none';
      }
    });
    
    // Function to load plot HTML
    function loadPlot(sampleId, magId) {
      const plotUrl = `plots/${sampleId}/${magId}.viz.html`;
      
      plotCard.style.display = 'block';
      loadingSpinner.style.display = 'block';
      plotContainer.innerHTML = '';
      
      fetch(plotUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load plot: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(html => {
          plotContainer.innerHTML = html;
          loadingSpinner.style.display = 'none';
          
          // Execute any scripts in the loaded HTML
          const scripts = plotContainer.querySelectorAll('script');
          scripts.forEach(script => {
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            if (script.src) {
              newScript.src = script.src;
            }
            document.head.appendChild(newScript);
          });
        })
        .catch(error => {
          console.error('Error loading plot:', error);
          plotContainer.innerHTML = `
            <div class="alert alert-warning" role="alert">
              <h6>Plot not available</h6>
              <p>Could not load plot for sample "${sampleId}" and MAG "${magId}".</p>
              <small class="text-muted">Expected location: ${plotUrl}</small>
            </div>
          `;
          loadingSpinner.style.display = 'none';
        });
    }
  });
</script>

{% endblock %}

{% block footer %}
{% set loading_selector = '#loading' %}
{% include 'js-error-handler.html' %}
{% endblock %}
