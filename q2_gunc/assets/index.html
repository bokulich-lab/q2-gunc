{% extends 'base.html' %}

{% block head %}
<title>Contig QC Dashboard (Vega-Lite)</title>
<!-- DaisyUI & Tailwind CDN -->
<link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<link href="css/styles.css" rel="stylesheet"/>
<script>
  window.q2_gunc_samples = {{ samples | safe }};
  window.q2_gunc_summaryData = {{ summary_data | safe }};
</script>
<script src="js/scripts.js"></script>
{% endblock %}

{% block content %}
<div class="w-full min-h-screen bg-base-200 flex flex-col items-center py-8">
  <div class="w-full">
    <div class="flex w-full items-stretch">

      <!-- 1. Sample and MAG Selectors -->
      <div class="w-5/6">
        <div class="card bg-base-100 shadow-md mb-6 ml-4 mr-4" id="selector-card">
          <div class="card-body">
            <h2 class="card-title mb-1 mt-1">Plot controls</h2>
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-1">
                <fieldset class="fieldset text-sm">
                  <label class="label">Sample</label>
                  <select class="select select-sm w-full" id="sample-selector">
                    <option value="" selected>-- All samples --</option>
                  </select>

                  <label class="label">Taxonomic level</label>
                  <select class="select select-sm w-full" id="level-selector">
                    <option value="kingdom">Kingdom</option>
                    <option value="phylum">Phylum</option>
                    <option value="class">Class</option>
                    <option value="order">Order</option>
                    <option value="family">Family</option>
                    <option value="genus">Genus</option>
                    <option value="species" selected>Species</option>
                  </select>

                  <label class="label">MAG</label>
                  <select class="select select-sm w-full" id="mag-selector">
                    <option value="">-- Select a MAG --</option>
                  </select>
                </fieldset>
              </div>

              <div class="flex-1 items-start ml-2">
                <fieldset class="fieldset text-sm" id="controls-container">
                  <p>
                    <input type="checkbox" class="checkbox checkbox-sm" id="filter-gunc-pass">
                    <span>Show GUNC-failed MAGs</span>
                  </p>
                  <p>
                    <input type="checkbox" class="checkbox checkbox-sm" id="reverse-y-axis" checked="checked">
                    <span>Reverse Y-axis</span>
                  </p>
                </fieldset>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="w-1/6 flex items-center justify-center mb-6 mr-4">
        <div class="stats stats-vertical shadow-md h-full w-full">
          <div class="stat bg-white">
            <div class="stat-title font-semibold">Samples</div>
            <div class="stat-value text-info"></div>
          </div>
          <div class="stat bg-white">
            <div class="stat-title font-semibold">MAGs</div>
            <div class="stat-value text-accent"></div>
            <div class="stat-desc">passing</div>
          </div>
          <div class="stat bg-white">
            <div class="stat-title font-semibold">MAGs</div>
            <div class="stat-value text-error"></div>
            <div class="stat-desc">failing</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. GUNC Summary Visualization -->
    <div class="card bg-base-100 shadow-md mb-6 ml-4 mr-4" id="summary-card">
      <div class="card-body p-6">
        <h2 class="card-title mb-1 mt-1">MAG quality summary</h2>
        <div id="gunc-summary-plot" class="min-h-[400px] w-full"></div>
      </div>
    </div>

    <!-- 3. Sankey Diagrams -->
    <div class="card bg-base-100 shadow-md mb-6 ml-4 mr-4" id="plot-card" style="display: none;">
      <div class="card-body p-6">
        <h2 class="card-title mb-4">GUNC Sankey diagram</h2>
        <div id="plot-container"></div>
        <div id="loading-spinner" class="flex justify-center mt-4" style="display: none;">
          <span class="loading loading-spinner loading-lg"></span>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block footer %}
{% set loading_selector = '#loading' %}
{% include 'js-error-handler.html' %}
{% endblock %}
